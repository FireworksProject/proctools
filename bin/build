#!/bin/bash
THISDIR="$(cd `dirname "$0"` && pwd)"
ROOTDIR="$( dirname "$THISDIR" )"
DISTDIR="$ROOTDIR/dist"
LIBDIR="$ROOTDIR/lib"

fail () {
	echo "$@" >&2
	exit 1
}

ensure_dir () {
    if ! [ -d "$1" ]; then
        mkdir -p -- "$1" || fail "couldn't create $1"
    fi
}

"$THISDIR/setup"
ensure_dir "$DISTDIR"
ensure_dir "$DISTDIR/lib"

cp "$ROOTDIR/package.json" "$DISTDIR/"
cd "$DISTDIR"
npm install

coffee --compile --bare "$ROOTDIR/index.coffee"
mv "$ROOTDIR/index.js" "$DISTDIR/"
coffee --compile --bare "$LIBDIR/proctools.coffee"
mv "$LIBDIR/proctools.js" "$DISTDIR/lib/"
