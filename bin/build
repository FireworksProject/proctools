#!/bin/bash
THISDIR="$(cd `dirname "$0"` && pwd)"
ROOTDIR="$( dirname "$THISDIR" )"
DISTDIR="$ROOTDIR/dist"
LIBDIR="$ROOTDIR/lib"

fail () {
	echo "$@" >&2
	exit 1
}

ensure_dir () {
    if ! [ -d "$1" ]; then
        mkdir -p -- "$1" || fail "couldn't create $1"
    fi
}

"$THISDIR/setup" || fail "unable to setup before build"
ensure_dir "$DISTDIR"
ensure_dir "$DISTDIR/lib"

cp "$ROOTDIR/package.json" "$DISTDIR/" || fail "unable to copy package.json"
cd "$DISTDIR"
npm install || fail "npm install error in dist/"

{ coffee --compile --bare "$ROOTDIR/index.coffee" && mv "$ROOTDIR/index.js" "$DISTDIR/"; } || \
    fail "unable to compile index.coffee"
{ coffee --compile --bare "$LIBDIR/proctools.coffee" && mv "$LIBDIR/proctools.js" "$DISTDIR/lib/"; } || \
    fail "unable to compile lib/proctools.coffee"

echo "ok: build done"
